# RAG 进阶实战：结构化数据与表格检索

欢迎来到 AI 应用开发的深水区！
在基础版 RAG 中，我们把所有文本都一视同仁地切成小块（Chunking）。但这在处理 **表格** 和 **层级文档** 时会遇到大麻烦。

本教程将带你通过“找茬”的方式，理解并解决这个问题。

## 🎯 任务目标
让 AI 准确回答 `finance_data.md` 报表中的复杂数据。

---

## 第一步：体验“失败” (使用基础版 RAG)

我们先用你之前的 `rag_app_minimal.py` 来测试新的数据。

1.  **准备数据**：我已经帮你创建了 `finance_data.md`，里面有两张表格（财务指标、客运票价）。
2.  **运行旧代码**：
    在终端运行：`streamlit run rag_app_minimal.py`
3.  **修改配置**：在左侧边栏，将“文档路径”改为 `finance_data.md`。
4.  **发起挑战**：
    试着问以下问题，观察 AI 的反应：
    *   *“2024年Q4的总营收是多少？”* (容易混淆Q3和Q4)
    *   *“火星探险的载客量是多少？”* (容易错位)
    *   *“运营成本为什么增加了？”* (需要关联右侧的“备注”列)

**观察点**：
打开页面下方的 `本次检索到的上下文` 展开栏。
你会发现表格的 Markdown 源码被切断了，或者表头（列名）和数据行分家了。LLM 就像在看一堆乱码，只能瞎猜。

---

## 第二步：引入“结构化感知” (使用进阶版 RAG)

为了解决这个问题，我们需要教 Python **“读懂 Markdown 的格式”**，而不是把它当成纯文本。

我们使用 LangChain 的 `MarkdownHeaderTextSplitter`。
它的原理是：**先按标题切分，把标题作为元数据（Metadata）贴在每一段正文上。**

### 代码解析 (请阅读 `rag_structure_aware.py`)

我在项目中为你创建了新文件 `rag_structure_aware.py`。请重点阅读 `build_vectorstore_advanced` 函数：

```python
# 核心逻辑剧透
headers_to_split_on = [
    ("#", "Header 1"),
    ("##", "Header 2"),
    ("###", "Header 3"),
]
# 这步操作后，文本块会变成：
# content: "火星探险 | 300 | 50 ..."
# metadata: {"Header 1": "核心财务指标", "Header 2": "客运部"}
```

这样，即使表格只有一行数据，它也永远背着“我是客运部火星探险项目”的标签，不会弄丢身份！

---

## 第三步：验证胜利

1.  **运行新代码**：
    停止之前的服务 (Ctrl+C)，然后运行：
    `streamlit run rag_structure_aware.py`
2.  **再次提问**：
    问同样的问题：*“火星探险的票价是多少？”*
3.  **查看导师视角**：
    展开底部的 `🔍 导师视角`。
    你会看到检索到的片段变成了这样：
    > 【章节：部门业绩拆解 > 客运部】
    > | 航线 | 票价 (万/人) | ...

    LLM 现在拥有了完整的上下文，回答准确率将大幅提升。

---

## 课后思考
如果表格特别大（超过 2000 字），连一个 Chunk 都装不下，这种方法也会失效。那时候该怎么办？
(提示：搜索关键词 "Parent Document Retriever" 或 "Table Summary RAG")
